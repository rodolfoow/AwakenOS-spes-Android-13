name: Build AwakenOS - Fixed API

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Test All API Endpoints
      run: |
        echo "üß™ Testing Crave.io API endpoints..."
        
        SERVER="${{ secrets.CRAVE_SERVER }}"
        TOKEN="${{ secrets.CRAVE_API_TOKEN }}"
        
        # Test different API endpoints
        ENDPOINTS=(
          "/api/v1/build"
          "/api/build"
          "/build"
          "/v1/build"
          "/api/v1/builds"
          "/build/create"
        )
        
        for endpoint in "${ENDPOINTS[@]}"; do
          echo -n "Testing https://$SERVER$endpoint ... "
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: $TOKEN" "https://$SERVER$endpoint")
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "201" ] || [ "$STATUS" = "400" ]; then
            echo "‚úÖ Found! (Status: $STATUS)"
            echo "::set-output name=api_endpoint::$endpoint"
            break
          else
            echo "‚ùå Failed (Status: $STATUS)"
          fi
        done
        
    - name: Start Build with Correct Endpoint
      id: build_step
      env:
        SERVER: ${{ secrets.CRAVE_SERVER }}
        TOKEN: ${{ secrets.CRAVE_API_TOKEN }}
      run: |
        echo "üîç Discovering correct API endpoint..."
        
        # Try to find the right endpoint
        TRY_ENDPOINTS() {
          local token="$1"
          local server="$2"
          
          # Try common endpoints
          local endpoints=(
            "/api/v1/builds"
            "/api/builds"
            "/builds"
            "/api/v1/build/create"
            "/api/build/create"
          )
          
          for endpoint in "${endpoints[@]}"; do
            echo "Trying: https://$server$endpoint"
            
            RESPONSE=$(curl -s -X GET \
              -H "Authorization: $token" \
              -H "Content-Type: application/json" \
              "https://$server$endpoint")
            
            if echo "$RESPONSE" | grep -q "builds\|id\|name"; then
              echo "‚úÖ Valid endpoint found: $endpoint"
              echo "$endpoint"
              return 0
            fi
          done
          
          return 1
        }
        
        ENDPOINT=$(TRY_ENDPOINTS "$TOKEN" "$SERVER")
        
        if [ -z "$ENDPOINT" ]; then
          echo "‚ùå Could not find valid API endpoint"
          echo "Trying POST request to known endpoints..."
          
          # Try POST to common endpoints
          BUILD_DATA='{"device":"spes","rom":"test"}'
          
          for endpoint in "/api/v1/builds" "/api/builds" "/builds"; do
            echo "POST to: https://$SERVER$endpoint"
            curl -v -X POST \
              -H "Authorization: $TOKEN" \
              -H "Content-Type: application/json" \
              -d "$BUILD_DATA" \
              "https://$SERVER$endpoint" && break
          done
          
          exit 1
        fi
        
        echo "‚úÖ Using endpoint: $ENDPOINT"
        
        # Now send actual build request
        BUILD_JSON='{
          "device": "spes",
          "rom": "awakenos",
          "android_version": "13",
          "sources": {
            "manifest": "https://github.com/Project-Awaken/android_manifest.git",
            "manifest_branch": "13.0",
            "device_tree": "https://github.com/sayann70/device_xiaomi_spes.git",
            "device_branch": "13.0",
            "vendor_tree": "https://github.com/sayann70/vendor_xiaomi_spes.git",
            "vendor_branch": "13.0",
            "kernel_source": "https://github.com/sayann70/android_kernel_xiaomi_spes.git",
            "kernel_branch": "13.0-triton-void"
          }
        }'
        
        echo "üì§ Sending build request..."
        curl -v -X POST \
          -H "Authorization: $TOKEN" \
          -H "Content-Type: application/json" \
          -H "User-Agent: Crave" \
          -d "$BUILD_JSON" \
          "https://$SERVER$ENDPOINT"
