name: Build AwakenOS for Redmi Note 11

on:
  workflow_dispatch:  # Faqat qo'lda ishga tushadi

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Test Connection
      run: |
        echo "=== Testing Connection to Crave.io ==="
        echo "Server: ${{ secrets.CRAVE_SERVER }}"
        echo "Username: ${{ secrets.CRAVE_USERNAME }}"
        
        # Test if server is reachable
        curl -I "https://${{ secrets.CRAVE_SERVER }}" || echo "Testing base URL..."
        
    - name: Start ROM Build
      env:
        SERVER: ${{ secrets.CRAVE_SERVER }}
        TOKEN: ${{ secrets.CRAVE_API_TOKEN }}
        USERNAME: ${{ secrets.CRAVE_USERNAME }}
      run: |
        echo "üöÄ Starting AwakenOS build for Redmi Note 11 (spes)..."
        
        # Check if all secrets are set
        if [ -z "$SERVER" ]; then
          echo "‚ùå ERROR: CRAVE_SERVER secret not set!"
          exit 1
        fi
        
        if [ -z "$TOKEN" ]; then
          echo "‚ùå ERROR: CRAVE_API_TOKEN secret not set!"
          exit 1
        fi
        
        echo "‚úÖ All secrets are set correctly!"
        
        # Create build request
        BUILD_JSON=$(cat <<EOF
        {
          "device": "spes",
          "codename": "spes",
          "rom": "awakenos",
          "version": "13.0",
          "source": {
            "manifest": "https://github.com/Project-Awaken/android_manifest.git",
            "branch": "13.0",
            "device": "https://github.com/sayann70/device_xiaomi_spes.git",
            "device_branch": "13.0",
            "vendor": "https://github.com/sayann70/vendor_xiaomi_spes.git",
            "vendor_branch": "13.0",
            "kernel": "https://github.com/sayann70/android_kernel_xiaomi_spes.git",
            "kernel_branch": "13.0-triton-void"
          },
          "parameters": {
            "clean": true,
            "type": "userdebug",
            "jobs": 4
          }
        }
        EOF
        )
        
        echo "üì¶ Build configuration:"
        echo "$BUILD_JSON" | jq '.' 2>/dev/null || echo "$BUILD_JSON"
        
        echo ""
        echo "üîó Sending request to: https://$SERVER/api/v1/build"
        
        # Send build request
        RESPONSE=$(curl -s -X POST "https://$SERVER/api/v1/build" \
          -H "Content-Type: application/json" \
          -H "Authorization: $TOKEN" \
          -H "User-Agent: Crave" \
          -d "$BUILD_JSON")
        
        echo "üì® Response from server:"
        echo "$RESPONSE"
        
        # Try to get build ID
        BUILD_ID=$(echo "$RESPONSE" | grep -o '"build_id":"[^"]*"' | cut -d'"' -f4)
        BUILD_ID_NUM=$(echo "$RESPONSE" | grep -o '"id":[0-9]*' | cut -d':' -f2)
        
        if [ -n "$BUILD_ID" ]; then
          echo "‚úÖ Build started successfully!"
          echo "üìù Build ID: $BUILD_ID"
        elif [ -n "$BUILD_ID_NUM" ]; then
          echo "‚úÖ Build started successfully!"
          echo "üìù Build ID: $BUILD_ID_NUM"
        else
          echo "‚ö†Ô∏è Could not parse build ID from response"
          echo "Check Crave.io dashboard manually"
        fi
        
    - name: Show Dashboard Links
      run: |
        echo ""
        echo "========================================"
        echo "üì± MONITOR YOUR BUILD:"
        echo ""
        echo "1Ô∏è‚É£ Crave.io Dashboard:"
        echo "   https://${{ secrets.CRAVE_SERVER }}/dashboard"
        echo ""
        echo "2Ô∏è‚É£ Builds List:"
        echo "   https://${{ secrets.CRAVE_SERVER }}/builds"
        echo ""
        echo "3Ô∏è‚É£ Direct Builds Page:"
        echo "   https://foss.crave.io/builds"
        echo ""
        echo "üí° TIP: Login with: ${{ secrets.CRAVE_USERNAME }}"
        echo "========================================"
        
    - name: Send Notification (Optional)
      if: success()
      run: |
        echo "‚úÖ Build request submitted successfully!"
        echo "Check your email or Crave.io dashboard for updates."
